'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import MobileLayout from '@/components/layout/MobileLayout';
import { motion } from 'framer-motion';
import { 
  Bell, 
  Moon, 
  Globe, 
  Shield, 
  Info, 
  ChevronRight,
  Smartphone,
  Database,
  Key,
  Download,
  Upload,
  RotateCcw,
  Eye,
  EyeOff,
  Package,
  AlertCircle,
  CheckCircle,
  Activity,
  Cpu,
  Zap,
  Star,
  RefreshCw
} from 'lucide-react';
import { useSettingsStore, useApiKeyStore } from '@/lib/settings-store';
import { checkAIProviderStatus } from '@/lib/meal-generation';
import { testProviderConnection, testMealGeneration, testImageRecognition, APITestResult } from '@/lib/api/api-test';
import ApiTestPanel from '@/components/settings/ApiTestPanel';
import NotificationSettings from '@/components/settings/NotificationSettings';
import CacheManager from '@/components/settings/CacheManager';
import UsageStatistics from '@/components/settings/UsageStatistics';

export default function SettingsPage() {
  const router = useRouter();
  const {
    darkMode,
    notifications,
    offlineMode,
    language,
    defaultServings,
    defaultCookingTime,
    toggleNotifications,
    toggleDarkMode,
    toggleOfflineMode,
    updateSettings,
    exportSettings,
    importSettings,
    resetSettings
  } = useSettingsStore();

  const {
    keys,
    setApiKey,
    getApiKey,
    clearAllKeys,
    setPreferredProvider,
    getPreferredProvider
  } = useApiKeyStore();

  const [showApiKeys, setShowApiKeys] = useState(false);
  const [apiKeyInputs, setApiKeyInputs] = useState({
    groqApiKey: '',
    geminiApiKey: '',
    huggingfaceApiKey: '',
    togetherApiKey: '',
    anthropicApiKey: '',
    openaiApiKey: '',
  });
  const [showSuccessMessage, setShowSuccessMessage] = useState('');
  const [aiProviderStatus, setAiProviderStatus] = useState<{
    available: boolean;
    providers: {
      mealGeneration: number;
      imageRecognition: number;
    };
    recommendations: {
      mealGeneration?: string;
      imageRecognition?: string;
    };
  } | null>(null);
  const [isCheckingProviders, setIsCheckingProviders] = useState(false);
  const [testResults, setTestResults] = useState<Record<string, APITestResult>>({});
  const [isTestingProvider, setIsTestingProvider] = useState<string | null>(null);
  const [preferredProviders, setPreferredProviders] = useState({
    mealGeneration: '',
    imageRecognition: '',
  });

  // Êñ∞Ê©üËÉΩ„ÅÆË°®Á§∫Áä∂ÊÖã
  const [showApiTestPanel, setShowApiTestPanel] = useState(false);
  const [showNotificationSettings, setShowNotificationSettings] = useState(false);
  const [showCacheManager, setShowCacheManager] = useState(false);
  const [showUsageStats, setShowUsageStats] = useState(false);

  // ÈÄöÁü•Ë®≠ÂÆö
  const [notificationSettings, setNotificationSettings] = useState({
    enabled: notifications,
    mealReminders: true,
    favoriteUpdates: false,
    weeklyPlanning: true,
    soundEnabled: true,
    vibrationEnabled: true,
    reminderTime: '18:00',
  });

  // ÂàùÊúüÂåñÊôÇ„Å´API„Ç≠„Éº„ÇíË™≠„ÅøËæº„Åø
  useEffect(() => {
    setApiKeyInputs({
      groqApiKey: getApiKey('groqApiKey'),
      geminiApiKey: getApiKey('geminiApiKey'),
      huggingfaceApiKey: getApiKey('huggingfaceApiKey'),
      togetherApiKey: getApiKey('togetherApiKey'),
      anthropicApiKey: getApiKey('anthropicApiKey'),
      openaiApiKey: getApiKey('openaiApiKey'),
    });

    // ÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„ÉºË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
    setPreferredProviders({
      mealGeneration: getPreferredProvider('mealGeneration'),
      imageRecognition: getPreferredProvider('imageRecognition'),
    });

    // AI„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÅÆÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    checkProviderStatus();
  }, [getApiKey, getPreferredProvider]);

  const checkProviderStatus = async () => {
    setIsCheckingProviders(true);
    try {
      const status = await checkAIProviderStatus();
      setAiProviderStatus(status);
      console.log('üîç AI„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÁä∂ÊÖã:', status);
    } catch (error) {
      console.error('AI„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÁä∂ÊÖãÁ¢∫Ë™ç„Ç®„É©„Éº:', error);
    } finally {
      setIsCheckingProviders(false);
    }
  };

  const handleApiKeyChange = (provider: keyof typeof apiKeyInputs, value: string) => {
    setApiKeyInputs(prev => ({ ...prev, [provider]: value }));
  };

  const handleApiKeySave = async (provider: keyof typeof apiKeyInputs) => {
    const key = apiKeyInputs[provider];
    console.log(`üîë API„Ç≠„Éº‰øùÂ≠ò: ${provider}`, { keyLength: key.length, hasKey: !!key });
    
    if (provider === 'groqApiKey') {
      console.log('üéØ Groq API„Ç≠„ÉºË©≥Á¥∞‰øùÂ≠òÊÉÖÂ†±:', {
        keyPreview: key ? `${key.substring(0, 15)}...` : '„Å™„Åó',
        keyLength: key.length,
        isValidFormat: key.startsWith('gsk_') || key.startsWith('sk-'),
        timestamp: new Date().toISOString()
      });
    }
    
    setApiKey(provider, key);
    
    // ‰øùÂ≠òÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅÂç≥Â∫ß„Å´ÂèñÂæó„Åó„Å¶„Åø„Çã
    const savedKey = getApiKey(provider);
    console.log(`‚úÖ API„Ç≠„Éº‰øùÂ≠òÁ¢∫Ë™ç: ${provider}`, { savedKeyLength: savedKey.length, matches: savedKey === key });
    
    setShowSuccessMessage(`${getProviderName(provider)}„ÅÆAPI„Ç≠„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
    setTimeout(() => setShowSuccessMessage(''), 3000);
    
    // API„Ç≠„Éº‰øùÂ≠òÂæå„Å´„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÁä∂ÊÖã„ÇíÂÜçÁ¢∫Ë™ç
    console.log('üîÑ „Éó„É≠„Éê„Ç§„ÉÄ„ÉºÁä∂ÊÖã„ÇíÂÜçÁ¢∫Ë™ç‰∏≠...');
    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà„Çπ„Éà„Ç¢„ÅÆÊõ¥Êñ∞„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã„Åü„ÇÅÔºâ
    setTimeout(async () => {
      await checkProviderStatus();
    }, 100);
  };

  const getProviderName = (provider: string) => {
    const names: Record<string, string> = {
      groqApiKey: 'Groq',
      geminiApiKey: 'Gemini',
      huggingfaceApiKey: 'HuggingFace',
      togetherApiKey: 'Together AI',
      anthropicApiKey: 'Anthropic',
      openaiApiKey: 'OpenAI'
    };
    return names[provider] || provider;
  };

  const getProviderCapabilities = (provider: string) => {
    const capabilities: Record<string, { meal: boolean; vision: boolean; quality: string }> = {
      groqApiKey: { meal: true, vision: true, quality: 'very-high' },
      geminiApiKey: { meal: true, vision: true, quality: 'very-high' },
      huggingfaceApiKey: { meal: true, vision: true, quality: 'medium' },
      togetherApiKey: { meal: true, vision: false, quality: 'high' },
      anthropicApiKey: { meal: true, vision: true, quality: 'very-high' },
      openaiApiKey: { meal: true, vision: true, quality: 'very-high' }
    };
    return capabilities[provider] || { meal: false, vision: false, quality: 'unknown' };
  };

  const handlePreferredProviderChange = (service: 'mealGeneration' | 'imageRecognition', provider: string) => {
    console.log(`üéØ ÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÂ§âÊõ¥: ${service} -> ${provider}`);
    setPreferredProvider(service, provider);
    setPreferredProviders(prev => ({ ...prev, [service]: provider }));
    setShowSuccessMessage(`${service === 'mealGeneration' ? 'ÁåÆÁ´ãÁîüÊàê' : 'ÁîªÂÉèË™çË≠ò'}„ÅÆÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„Éº„Çí${getProviderName(provider)}„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`);
    setTimeout(() => setShowSuccessMessage(''), 3000);
  };

  const handleExportSettings = () => {
    const settingsJson = exportSettings();
    const blob = new Blob([settingsJson], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'mobile-kondate-settings.json';
    a.click();
    URL.revokeObjectURL(url);
    setShowSuccessMessage('Ë®≠ÂÆö„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
    setTimeout(() => setShowSuccessMessage(''), 3000);
  };

  const handleImportSettings = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      const content = e.target?.result as string;
      const success = importSettings(content);
      if (success) {
        setShowSuccessMessage('Ë®≠ÂÆö„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
        // „Ç§„É≥„Éù„Éº„ÉàÂæå„Å´API„Ç≠„Éº„ÇíÂÜçË™≠„ÅøËæº„Åø
        setApiKeyInputs({
          groqApiKey: getApiKey('groqApiKey'),
          geminiApiKey: getApiKey('geminiApiKey'),
          huggingfaceApiKey: getApiKey('huggingfaceApiKey'),
          togetherApiKey: getApiKey('togetherApiKey'),
          anthropicApiKey: getApiKey('anthropicApiKey'),
          openaiApiKey: getApiKey('openaiApiKey'),
        });
        await checkProviderStatus();
      } else {
        setShowSuccessMessage('Ë®≠ÂÆö„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
      setTimeout(() => setShowSuccessMessage(''), 3000);
    };
    reader.readAsText(file);
  };

  const handleResetSettings = async () => {
    if (confirm('„Åô„Åπ„Å¶„ÅÆË®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
      resetSettings();
      clearAllKeys();
      setApiKeyInputs({
        groqApiKey: '',
        geminiApiKey: '',
        huggingfaceApiKey: '',
        togetherApiKey: '',
        anthropicApiKey: '',
        openaiApiKey: '',
      });
      setAiProviderStatus(null);
      setShowSuccessMessage('Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
      setTimeout(() => setShowSuccessMessage(''), 3000);
    }
  };

  // API „ÉÜ„Çπ„ÉàÈñ¢Êï∞
  const handleTestProvider = async (provider: string, testType: 'connection' | 'meal' | 'vision') => {
    try {
      // API„Ç≠„Éº„ÇíÂèñÂæó
      const apiKey = getApiKey(provider as any);
      if (!apiKey) {
        return {
          success: false,
          message: 'API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì',
          responseTime: 0
        };
      }

      switch (testType) {
        case 'connection':
          const result = await testProviderConnection(provider, apiKey);
          return {
            success: result.success,
            message: result.error || (result.success ? 'Êé•Á∂öÊàêÂäü' : 'Êé•Á∂öÂ§±Êïó'),
            responseTime: result.responseTime || 0
          };
        case 'meal':
          const mealResult = await testMealGeneration(provider);
          return {
            success: mealResult.success,
            message: mealResult.error || (mealResult.success ? 'ÁåÆÁ´ãÁîüÊàêÊàêÂäü' : 'ÁåÆÁ´ãÁîüÊàêÂ§±Êïó'),
            responseTime: 0 // testMealGeneration doesn't return responseTime
          };
        case 'vision':
          const visionResult = await testImageRecognition(provider);
          return {
            success: visionResult.success,
            message: visionResult.error || (visionResult.success ? 'ÁîªÂÉèË™çË≠òÊàêÂäü' : 'ÁîªÂÉèË™çË≠òÂ§±Êïó'),
            responseTime: 0 // testImageRecognition doesn't return responseTime
          };
        default:
          throw new Error('‰∏çÊòé„Å™„ÉÜ„Çπ„Éà„Çø„Ç§„Éó');
      }
    } catch (error) {
      return {
        success: false,
        message: error instanceof Error ? error.message : '„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
      };
    }
  };

  // ÈÄöÁü•Ë®≠ÂÆöÊõ¥Êñ∞
  const handleNotificationSettingsUpdate = (newSettings: any) => {
    setNotificationSettings(newSettings);
    updateSettings({ notifications: newSettings.enabled });
  };

  const settingsGroups = [
    {
      title: 'AI „Éó„É≠„Éê„Ç§„ÉÄ„ÉºË®≠ÂÆö',
      items: [
        {
          icon: Activity,
          label: '„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÁä∂ÊÖã',
          value: aiProviderStatus ? (
            <div className="flex items-center gap-2">
              <div className={`w-2 h-2 rounded-full ${
                aiProviderStatus.available ? 'bg-green-500' : 'bg-red-500'
              }`} />
              <span className="text-sm">
                {aiProviderStatus.available 
                  ? `${aiProviderStatus.providers.mealGeneration + aiProviderStatus.providers.imageRecognition}ÂÄãÊúâÂäπ`
                  : 'ÁÑ°Âäπ'
                }
              </span>
            </div>
          ) : (
            <div className="flex items-center gap-2">
              <div className="w-2 h-2 rounded-full bg-gray-500" />
              <span className="text-sm">Á¢∫Ë™ç‰∏≠...</span>
            </div>
          ),
          action: () => checkProviderStatus(),
          type: 'button' as const,
        },
        {
          icon: Key,
          label: 'API„Ç≠„ÉºÁÆ°ÁêÜ',
          value: `${Object.values(apiKeyInputs).filter(key => key).length}/6 Ë®≠ÂÆöÊ∏à„Åø`,
          action: () => setShowApiKeys(!showApiKeys),
          type: 'button' as const,
        },
        {
          icon: Zap,
          label: 'APIÊé•Á∂ö„ÉÜ„Çπ„Éà',
          value: '„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÂãï‰ΩúÁ¢∫Ë™ç',
          action: () => setShowApiTestPanel(!showApiTestPanel),
          type: 'button' as const,
        },
      ]
    },
    {
      title: '„Ç¢„Éó„É™Ë®≠ÂÆö',
      items: [
        {
          icon: Bell,
          label: '„Éó„ÉÉ„Ç∑„É•ÈÄöÁü•',
          value: notifications,
          action: toggleNotifications,
          type: 'toggle' as const,
        },
        {
          icon: Bell,
          label: 'ÈÄöÁü•Ë®≠ÂÆöË©≥Á¥∞',
          value: 'ÈÄöÁü•„Ç´„ÉÜ„Ç¥„É™„Éª„Çø„Ç§„Éü„É≥„Ç∞',
          action: () => setShowNotificationSettings(!showNotificationSettings),
          type: 'button' as const,
        },
        {
          icon: Moon,
          label: '„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ',
          value: darkMode,
          action: toggleDarkMode,
          type: 'toggle' as const,
        },
        {
          icon: Globe,
          label: 'Ë®ÄË™ûË®≠ÂÆö',
          value: language === 'ja' ? 'Êó•Êú¨Ë™û' : 'English',
          action: () => updateSettings({ language: language === 'ja' ? 'en' : 'ja' }),
          type: 'button' as const,
        },
        {
          icon: Database,
          label: '„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ',
          value: offlineMode,
          action: toggleOfflineMode,
          type: 'toggle' as const,
        },
      ]
    },
    {
      title: '„Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö',
      items: [
        {
          icon: Package,
          label: 'È£üÊùêÂú®Â∫´ÁÆ°ÁêÜ',
          value: 'ÂÜ∑ËîµÂ∫´„ÅÆ‰∏≠Ë∫´„ÇíÁÆ°ÁêÜ',
          action: () => router.push('/inventory'),
          type: 'button' as const,
        },
        {
          icon: Smartphone,
          label: '„Éá„Éï„Ç©„É´„Éà‰∫∫Êï∞',
          value: `${defaultServings}‰∫∫ÂàÜ`,
          action: () => {
            const servings = prompt('„Éá„Éï„Ç©„É´„Éà„ÅÆ‰∫∫Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', defaultServings.toString());
            if (servings && !isNaN(Number(servings))) {
              updateSettings({ defaultServings: Number(servings) });
            }
          },
          type: 'button' as const,
        },
        {
          icon: Smartphone,
          label: '„Éá„Éï„Ç©„É´„ÉàË™øÁêÜÊôÇÈñì',
          value: `${defaultCookingTime}ÂàÜ`,
          action: () => {
            const time = prompt('„Éá„Éï„Ç©„É´„Éà„ÅÆË™øÁêÜÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂàÜÔºâ', defaultCookingTime.toString());
            if (time && !isNaN(Number(time))) {
              updateSettings({ defaultCookingTime: time });
            }
          },
          type: 'button' as const,
        },
      ]
    },
    {
      title: '„Éá„Éº„ÇøÁÆ°ÁêÜ',
      items: [
        {
          icon: Database,
          label: '„Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜ',
          value: '„Çπ„Éà„É¨„Éº„Ç∏‰ΩøÁî®ÈáèÁ¢∫Ë™ç',
          action: () => setShowCacheManager(!showCacheManager),
          type: 'button' as const,
        },
        {
          icon: Download,
          label: 'Ë®≠ÂÆö„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
          value: 'JSONÂΩ¢Âºè„Åß‰øùÂ≠ò',
          action: handleExportSettings,
          type: 'button' as const,
        },
        {
          icon: Upload,
          label: 'Ë®≠ÂÆö„Çí„Ç§„É≥„Éù„Éº„Éà',
          value: 'JSON„Éï„Ç°„Ç§„É´„Åã„ÇâÂæ©ÂÖÉ',
          action: () => document.getElementById('import-input')?.click(),
          type: 'button' as const,
        },
        {
          icon: RotateCcw,
          label: 'Ë®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà',
          value: '„Åô„Åπ„Å¶ÂàùÊúüÂåñ',
          action: handleResetSettings,
          type: 'button' as const,
          danger: true,
        },
      ]
    },
    {
      title: 'Áµ±Ë®à„ÉªÂàÜÊûê',
      items: [
        {
          icon: Activity,
          label: '‰ΩøÁî®Áµ±Ë®à',
          value: '„Ç¢„Éó„É™„ÅÆÂà©Áî®Áä∂Ê≥Å',
          action: () => setShowUsageStats(!showUsageStats),
          type: 'button' as const,
        },
      ]
    },
    {
      title: '„Ç¢„Éó„É™ÊÉÖÂ†±',
      items: [
        {
          icon: Info,
          label: '„Éê„Éº„Ç∏„Éß„É≥',
          value: '1.2.0',
          type: 'display' as const,
        },
        {
          icon: Shield,
          label: '„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº',
          value: '',
          action: () => window.open('/privacy', '_blank'),
          type: 'button' as const,
        },
      ]
    }
  ];

  return (
    <MobileLayout title="Ë®≠ÂÆö">
      <div className="px-4 py-6 space-y-6">
        {/* ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ */}
        {showSuccessMessage && (
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2"
          >
            <CheckCircle className="w-4 h-4 text-green-600" />
            <span className="text-green-800 text-sm">{showSuccessMessage}</span>
          </motion.div>
        )}

        {/* AI„Éó„É≠„Éê„Ç§„ÉÄ„ÉºË©≥Á¥∞Áä∂ÊÖã */}
        {aiProviderStatus && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-blue-50 border border-blue-200 rounded-lg p-4"
          >
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-blue-900 flex items-center gap-2">
                <Cpu className="w-5 h-5" />
                AIÊ©üËÉΩÁä∂ÊÖã
              </h3>
              <button
                onClick={checkProviderStatus}
                disabled={isCheckingProviders}
                className="text-blue-600 hover:text-blue-800 transition-colors disabled:opacity-50"
              >
                <RefreshCw className={`w-4 h-4 ${isCheckingProviders ? 'animate-spin' : ''}`} />
              </button>
            </div>
            
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div className="bg-white rounded-lg p-3">
                <div className="flex items-center gap-2 mb-2">
                  <Zap className="w-4 h-4 text-blue-600" />
                  <span className="font-medium text-gray-900">ÁåÆÁ´ãÁîüÊàê</span>
                </div>
                <div className="text-2xl font-bold text-blue-600">
                  {aiProviderStatus.providers.mealGeneration}
                </div>
                <div className="text-xs text-gray-600">„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÂà©Áî®ÂèØËÉΩ</div>
                {aiProviderStatus.recommendations.mealGeneration && (
                  <div className="mt-2 flex items-center gap-1">
                    <Star className="w-3 h-3 text-yellow-500" />
                    <span className="text-xs text-gray-700">
                      Êé®Â•®: {aiProviderStatus.recommendations.mealGeneration}
                    </span>
                  </div>
                )}
              </div>
              
              <div className="bg-white rounded-lg p-3">
                <div className="flex items-center gap-2 mb-2">
                  <Eye className="w-4 h-4 text-green-600" />
                  <span className="font-medium text-gray-900">ÁîªÂÉèË™çË≠ò</span>
                </div>
                <div className="text-2xl font-bold text-green-600">
                  {aiProviderStatus.providers.imageRecognition}
                </div>
                <div className="text-xs text-gray-600">„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÂà©Áî®ÂèØËÉΩ</div>
                {aiProviderStatus.recommendations.imageRecognition && (
                  <div className="mt-2 flex items-center gap-1">
                    <Star className="w-3 h-3 text-yellow-500" />
                    <span className="text-xs text-gray-700">
                      Êé®Â•®: {aiProviderStatus.recommendations.imageRecognition}
                    </span>
                  </div>
                )}
              </div>
            </div>
            
            <div className="text-xs text-blue-700">
              {aiProviderStatus.available 
                ? 'AIÊ©üËÉΩ„ÅåÊ≠£Â∏∏„Å´Âà©Áî®„Åß„Åç„Åæ„Åô'
                : 'API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶AIÊ©üËÉΩ„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
              }
            </div>
          </motion.div>
        )}

        {/* API„Ç≠„ÉºË®≠ÂÆö„Éë„Éç„É´ */}
        {showApiKeys && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="bg-white border border-gray-200 rounded-lg overflow-hidden"
          >
            <div className="p-4 border-b border-gray-100">
              <h3 className="font-semibold text-gray-900 flex items-center gap-2">
                <Key className="w-5 h-5" />
                API„Ç≠„ÉºË®≠ÂÆö
              </h3>
              <p className="text-sm text-gray-600 mt-1">
                ÂêÑ„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÅÆAPI„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶AIÊ©üËÉΩ„ÇíÊúâÂäπ„Å´„Åß„Åç„Åæ„Åô„ÄÇAPI„Ç≠„Éº‰øùÂ≠òÂæå„ÄÅÊ©üËÉΩÂà•„ÅÆÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇ
              </p>
            </div>
            
            <div className="divide-y divide-gray-100">
              {Object.entries(apiKeyInputs).map(([provider, value]) => {
                const capabilities = getProviderCapabilities(provider);
                const isConfigured = !!value;
                
                return (
                  <div key={provider} className="p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <div className={`w-3 h-3 rounded-full ${
                          isConfigured ? 'bg-green-500' : 'bg-gray-300'
                        }`} />
                        <div>
                          <div className="font-medium text-gray-900">
                            {getProviderName(provider)}
                          </div>
                          <div className="flex items-center gap-2 text-xs text-gray-600">
                            {capabilities.meal && (
                              <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">
                                ÁåÆÁ´ãÁîüÊàê
                              </span>
                            )}
                            {capabilities.vision && (
                              <span className="px-2 py-1 bg-green-100 text-green-700 rounded">
                                ÁîªÂÉèË™çË≠ò
                              </span>
                            )}
                            <span className={`px-2 py-1 rounded ${
                              capabilities.quality === 'very-high' ? 'bg-purple-100 text-purple-700' :
                              capabilities.quality === 'high' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {capabilities.quality === 'very-high' ? 'ÊúÄÈ´òÂìÅË≥™' :
                               capabilities.quality === 'high' ? 'È´òÂìÅË≥™' : 'Ê®ôÊ∫ñÂìÅË≥™'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex gap-2">
                      <input
                        type="password"
                        value={value}
                        onChange={(e) => handleApiKeyChange(provider as keyof typeof apiKeyInputs, e.target.value)}
                        placeholder={`${getProviderName(provider)} API„Ç≠„Éº„ÇíÂÖ•Âäõ`}
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <button
                        onClick={() => handleApiKeySave(provider as keyof typeof apiKeyInputs)}
                        disabled={!value}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
                      >
                        ‰øùÂ≠ò
                      </button>
                    </div>
                    
                    {/* ÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÈÅ∏Êäû„Ç™„Éó„Ç∑„Éß„É≥ */}
                    {isConfigured && (
                      <div className="mt-3 space-y-2">
                        <div className="text-sm font-medium text-gray-700">„Åì„ÅÆ„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÇíÂÑ™ÂÖà‰ΩøÁî®„Åô„ÇãÊ©üËÉΩ:</div>
                        <div className="flex gap-2">
                          {capabilities.meal && (
                            <label className="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                              <input
                                type="radio"
                                name={`${provider}_meal`}
                                checked={preferredProviders.mealGeneration === provider}
                                onChange={() => handlePreferredProviderChange('mealGeneration', provider)}
                                className="text-blue-600 focus:ring-blue-500"
                              />
                              <span className="text-sm font-medium text-gray-700">ÁåÆÁ´ãÁîüÊàê</span>
                              <Zap className="w-3 h-3 text-blue-500" />
                            </label>
                          )}
                          {capabilities.vision && (
                            <label className="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                              <input
                                type="radio"
                                name={`${provider}_vision`}
                                checked={preferredProviders.imageRecognition === provider}
                                onChange={() => handlePreferredProviderChange('imageRecognition', provider)}
                                className="text-green-600 focus:ring-green-500"
                              />
                              <span className="text-sm font-medium text-gray-700">ÁîªÂÉèË™çË≠ò</span>
                              <Eye className="w-3 h-3 text-green-500" />
                            </label>
                          )}
                        </div>
                        
                        {/* ÁèæÂú®„ÅÆË®≠ÂÆöË°®Á§∫ */}
                        <div className="text-xs text-gray-500 border-t border-gray-100 pt-2 mt-2">
                          {preferredProviders.mealGeneration === provider && capabilities.meal && (
                            <span className="inline-flex items-center gap-1 mr-3">
                              <Zap className="w-3 h-3 text-blue-500" />
                              ÁåÆÁ´ãÁîüÊàê„ÅßÂÑ™ÂÖà‰ΩøÁî®‰∏≠
                            </span>
                          )}
                          {preferredProviders.imageRecognition === provider && capabilities.vision && (
                            <span className="inline-flex items-center gap-1">
                              <Eye className="w-3 h-3 text-green-500" />
                              ÁîªÂÉèË™çË≠ò„ÅßÂÑ™ÂÖà‰ΩøÁî®‰∏≠
                            </span>
                          )}
                          {preferredProviders.mealGeneration !== provider && preferredProviders.imageRecognition !== provider && (
                            <span className="text-gray-400">ÂÑ™ÂÖà‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            
            <div className="p-4 bg-gray-50 border-t border-gray-100">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 text-amber-600 mt-0.5" />
                <div className="text-sm text-amber-800">
                  <div className="font-medium mb-1">API„Ç≠„Éº„Å´„Å§„ÅÑ„Å¶</div>
                  <ul className="text-xs space-y-1">
                    <li>‚Ä¢ API„Ç≠„Éº„ÅØ„É≠„Éº„Ç´„É´„Å´ÂÆâÂÖ®„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô</li>
                    <li>‚Ä¢ Ê©üËÉΩÂà•„Å´ÂÑ™ÂÖà„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÇíÊåáÂÆö„Åß„Åç„Åæ„ÅôÔºàÁåÆÁ´ãÁîüÊàê„ÉªÁîªÂÉèË™çË≠òÔºâ</li>
                    <li>‚Ä¢ ÂÑ™ÂÖàË®≠ÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÈÅ©„Å™„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÅåËá™ÂãïÈÅ∏Êäû„Åï„Çå„Åæ„Åô</li>
                    <li>‚Ä¢ API„Ç≠„Éº„ÅØÊöóÂè∑Âåñ„Åï„Çå„Å¶„Éñ„É©„Ç¶„Ç∂„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åô</li>
                  </ul>
                </div>
              </div>
            </div>
          </motion.div>
        )}

        {/* API „ÉÜ„Çπ„Éà„Éë„Éç„É´ */}
        {showApiTestPanel && (
          <ApiTestPanel 
            providers={Object.entries(apiKeyInputs)
              .filter(([_, key]) => key)
              .map(([provider, key]) => ({
                key: provider,
                name: getProviderName(provider),
                hasKey: !!key,
                capabilities: getProviderCapabilities(provider)
              }))}
            onTestProvider={handleTestProvider}
          />
        )}

        {/* ÈÄöÁü•Ë®≠ÂÆöË©≥Á¥∞ */}
        {showNotificationSettings && (
          <NotificationSettings 
            settings={notificationSettings}
            onUpdate={handleNotificationSettingsUpdate}
          />
        )}

        {/* „Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜ */}
        {showCacheManager && <CacheManager />}

        {/* ‰ΩøÁî®Áµ±Ë®à */}
        {showUsageStats && <UsageStatistics />}

        {/* Ë®≠ÂÆö„Ç∞„É´„Éº„Éó */}
        {settingsGroups.map((group, groupIndex) => (
          <motion.div
            key={group.title}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: groupIndex * 0.1 }}
            className="bg-white border border-gray-200 rounded-lg overflow-hidden"
          >
            <div className="p-4 border-b border-gray-100">
              <h3 className="font-semibold text-gray-900">{group.title}</h3>
            </div>
            
            <div className="divide-y divide-gray-100">
              {group.items.map((item, itemIndex) => (
                <div
                  key={itemIndex}
                  className={`p-4 flex items-center justify-between ${
                    item.type === 'button' ? 'hover:bg-gray-50 cursor-pointer' : ''
                  } ${(item as any).danger ? 'hover:bg-red-50' : ''}`}
                  onClick={item.type === 'button' ? item.action : undefined}
                >
                  <div className="flex items-center gap-3">
                    <item.icon className={`w-5 h-5 ${
                      (item as any).danger ? 'text-red-600' : 'text-gray-600'
                    }`} />
                    <span className={`font-medium ${
                      (item as any).danger ? 'text-red-900' : 'text-gray-900'
                    }`}>
                      {item.label}
                    </span>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    {item.type === 'toggle' ? (
                      <button
                        onClick={item.action}
                        className={`w-12 h-6 rounded-full transition-colors ${
                          item.value ? 'bg-blue-600' : 'bg-gray-300'
                        }`}
                      >
                        <div className={`w-5 h-5 bg-white rounded-full transition-transform ${
                          item.value ? 'translate-x-6' : 'translate-x-0.5'
                        }`} />
                      </button>
                    ) : item.type === 'button' ? (
                      <>
                        <span className="text-sm text-gray-600">{item.value}</span>
                        <ChevronRight className="w-4 h-4 text-gray-400" />
                      </>
                    ) : (
                      <span className="text-sm text-gray-600">{item.value}</span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </motion.div>
        ))}

        {/* Èö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ */}
        <input
          id="import-input"
          type="file"
          accept=".json"
          onChange={handleImportSettings}
          className="hidden"
        />
      </div>
    </MobileLayout>
  );
}
